# File Analysis

## ADS

In NTFS file systems it is allowed to store meta information with a file, this data is known as ADS (Alternative Data Streams), this meta information can be used to hide information or files.

To list the files and their Alternative Data Streams the '/R' flag is used:

```
C:\> dir /R
```

To store a file as ADS of another file, use the command 'type file_to_store.ext > main_file.ext:stored_data.ext'

In the following example the file 'to_hide.txt' is stored as ADS of the file 'main.txt'

```
C:\test>dir /R
...
99/99/9999  99:99    <DIR>          .
99/99/9999  99:99    <DIR>          ..
99/99/9999  99:99                41 main.txt
99/99/9999  99:99                41 to_hide.txt
...

C:\test>type to_hide.txt > main.txt:hide.txt

C:\test>dir /R
...
99/99/9999  99:99    <DIR>          .
99/99/9999  99:99    <DIR>          ..
99/99/9999  99:99                41 main.txt
                                 41 main.txt:hide.txt:$DATA
99/99/9999  99:99                41 to_hide.txt
...
```

In this example, the 'more' command can be used to display the data of the file added as ADS:




```
C:\test>more < main.txt
"This is the content of the main file"

C:\test>more < main.txt:hide.txt
"This is the content of the ADS file!"
```

It is also possible to store image files to later viewing with your preferred image viewer:

```
C:\test>type image.png > main.txt:hide_image.png

C:\test>dir /R
...
99/99/9999  99:99    <DIR>          .
99/99/9999  99:99    <DIR>          ..
99/99/9999  99:99           112.401 image.png
99/99/9999  99:99                41 main.txt
                            112.401 main.txt:hide_image.png:$DATA
...

C:\test>mspaint main.txt:hide_image.png
```

New OS do not allow calls to executable files stored as ADS, but we can use ADS to run a script tha executes it.

The following example shows how to store as ADS of the file 'main.txt' a python script that executes the Windows calculator:

```
C:\test>type script_py.txt
#!/usr/bin/env python
# -*- coding: utf-8 -*-
import sys, string, os
os.system('C:\Windows\System32\calc.exe')
C:\test>type script_py.txt > main.txt:calc_caller.exe

C:\test>python main.txt:calc_caller.exe
```
<mark style="color:yellow;">**NB!**</mark> In Windows, you can always run a file with the default application associated with its extension with the 'start' command.

## File Type Identification

### Using Linux

~~~
$ file fileName.ext
~~~

### Using Magic Numbers

We can identify the **file type** through its file signatures (aka 'magic numbers').
First we obtain the initial magic numbers of the file and then we can check on the internet to see what type of file they belong to.
A useful resource for this is the github [File Magic Numbers](https://gist.github.com/leommoore/f9e57ba2aa4bf197ebc5) by leommoore

#### To get the Magic Numbers with PowerShell

```
PS C:\> Format-Hex -Path fileName | Select-Object -First 1
```

#### Alternative Method
knowing the initial magic numbers of the file we want to identify, we can create in linux any file, edit it with 'hexedit' to replace its initial magic numbers with these and use the 'file' command to identify it:

```
$ echo "Helo" > test_file
$ file test_file
test_file: ASCII text
$ hexedit test_file
00000000   89 50 4E 47  0D 0A 1A 0A  00 00 00 0D  49 48 44 52					.PNG........IHDR
...
$ file test_file
test_file: PNG image data, 0 x 0, 0-bit grayscale, non-interlaced
```

## Information Extraction
### Metadata
```
$ exiftool fileName.ext
```
or

```
exiftool fileName.ext | grep -i -E "creator|author|mime type"
```

Where:

* <mark style="color:orange;">-i</mark> → is not case-sensitive
* <mark style="color:orange;">-E</mark> → values will be interpreted as an extended regular expression, you can filter for several values simultaneously

### Binary Information
```
$ rabin2 -I fileName.ext
```

### Hexadecimal Information
```
$ hexdump -c fileName.ext
```

### Printable Characters
May contain hardcoded credentials

#### With Strings
```
$ strings fileName.ext
$ strings fileName.ext -n 10
```
Where:

* <mark style="color:orange;">-n</mark>	→ list only strings longer than 10 characters

#### With Rabin
```
$ rabin2 -zqq fileName.ext
$ rabin2 -zqq fileName.ext | less -S
```
Where:

* <mark style="color:orange;"> | less -S</mark>	→ prints long strings only

#### With Radare
- Load the file
```
$ radare2 fileName.exe
[0x004092f5]>
```

- List Radare Options
```
$ radare2  fileName.exe
[0x004092f5]> aaaa
[x] Analyze all flags starting with sym. and entry0 (aa)
[x] Analyze function calls (aac)
[x] Analyze len bytes of instructions for references (aar)
[x] Check for objc references
[x] Check for vtables
[x] Type matching analysis for all functions (aaft)
[x] Propagate noreturn information
[x] Use -AA or aaaa to perform additional experimental analysis.
[x] Finding function preludes
[x] Enable constraint types analysis for variables
```
- List Functions in the program
```
[0x004092f5]> afl
0x004092f5   21 376  -> 315  entry0
0x004011a0   23 597  -> 592  main
0x004028c0    1 24           fcn.004028c0
0x0040696c    5 45           fcn.0040696c
...
```
<mark style="color:yellow;">**NB!**</mark> main is usually the main function and one of those that may be interesting to analyze

- Move to a Function
syntax: *s nombreDeLaFunción*
e.g: [0x004092f5]> s main

- List Contents of a Function
syntax: *pdf nombreDeLaFunción*
e.g: [0x004092f5]> pdf main

### IMAGE Files
To display the image in linux
```
$ ristretto filename.ext
```
To extracts the information hidden in the least significant bits of an image
```
$ steghide info filename.ext
```

### .BIN (frimware) Files
To extracts embedded file systems from firmware images
$ binwalk filename.ext

### .journal Files
Syntax: $ journalctl --file </path/to/file.journal>

## Useful Tools

### WPS 2019
[WPS 2019](https://www.wps.com/download/) is an Office suite compatible with Office documents that respects and maintains the proportions of the documents.

* NOTE: the installation of the following tools may require the prior installation of the following packages:
	- pip install -U pip
	- pip2 install setuptools
	- apt-get install build-essential
	- apt-get install python-dev

### Ole-Tools
#### Description
> Python tools for parsing MS OLE2 files and MS Office documents (structured storage, compound binary file format).
> (structured storage, binary compound file format)
> Used for malware analysis, forensic analysis and debugging.
> URL: https://github.com/decalage2/oletools

#### Installation
```
$ pip3 install -U oletools
```

#### Usage
Perform an analysis of the results (without going into the macro code)
```
$ olevba3 -a docFileName.ext 2>/dev/null
$ olevba3 -a docFileName.ext --decode 2>/dev/null
```
Display the VBA code, without parsing it
```
$ olevba3 -c docFileName.ext 2>/dev/null
```

### ViperMonkey
#### Description
> A VBA parser and emulation engine for parsing malicious macros.
> URL: https://github.com/decalage2/ViperMonkey

#### Installation
```
$ pip2 install -U https://github.com/decalage2/ViperMonkey/archive/master.zip
```

#### Usage
Scan
```
$ vmonkey docFileName.ext 2>/dev/null
```
Analysis with indicators of compromise
```
$ vmonkey -c docFileName.ext 2>/dev/null
```

### Hybrid Analysis
#### Description
> Free web application for malware analysis.
> Allows to run the file on different remote VMs of different versions and makes a report.
> URL: https://www.hybrid-analysis.com

#### Usage
> Upload the file to the field provided for this purpose
> Generate the report
> Check especially the "Informative" field of the Falcon Sandbox Reports. If you have Macros you will see the content in this field in the "***Contains embedded VBA macros***" section.


### FixGZ
#### Description
> Application to repair damaged .gz files

#### Resource
[FixGZ](https://web.archive.org/web/20180624175352/http://www.gzip.org/fixgz.zip)
and compile
```
$ gcc fixgz.c -o fixgz
```

#### Usage
```
$ fixgz damaged_filename.gz fixed_filename.gz
```